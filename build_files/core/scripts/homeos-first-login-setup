#!/bin/bash
# homeOS first login setup script
# This script runs automatically on first user login and when configuration updates

# Script version - increment when adding new features
SCRIPT_VERSION="0.0.1"
VERSION_FILE="$HOME/.config/homeos-first-login-version"
LANG_CODE=${LANG:0:2}

# Check current version
CURRENT_VERSION=""
if [ -f "$VERSION_FILE" ]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE")
fi

# Show zenity info screen in German or English
if command -v zenity &> /dev/null; then
    if [ "$LANG_CODE" = "de" ]; then
        zenity --info --width=400 --title="homeOS Einrichtung" --text="Bitte warten Sie während wir Ihr System konfigurieren..." &
    else
        zenity --info --width=400 --title="homeOS Setup" --text="Please wait while we configure your system..." &
    fi
fi

# Check if Internet is available
if ! ping -c 1 8.8.8.8 &> /dev/null; then
    echo "⚠ No internet connection detected. Setup cannot continue."
    if [ "$LANG_CODE" = "de" ]; then
        notify-send "homeOS Setup" "Keine Internetverbindung erkannt. Bitte verbinden Sie sich mit dem Internet und starten Sie den Computer neu, um die Einrichtung abzuschließen." --icon=dialog-warning
    else
        notify-send "homeOS Setup" "No internet connection detected. Please connect to the internet and restart your computer to complete setup." --icon=dialog-warning
    fi
    exit 1
fi

# Skip if already run with same or newer version
if [ "$CURRENT_VERSION" = "$SCRIPT_VERSION" ]; then
    exit 0
fi

echo "Internet connection detected. Continuing setup..."

echo "Setting up homeOS user session (version $SCRIPT_VERSION)..."

# Show what's being updated if this is an upgrade
if [ -n "$CURRENT_VERSION" ] && [ "$CURRENT_VERSION" != "$SCRIPT_VERSION" ]; then
    echo "Upgrading homeOS user configuration from $CURRENT_VERSION to $SCRIPT_VERSION"
fi

# Read Flatpak list from flatpaks.txt file
FLATPAKS_FILE="/etc/homeos/flatpaks.txt"

# Install Flatpaks from the list
if [ -f "$FLATPAKS_FILE" ]; then
    echo "Reading Flatpaks from $FLATPAKS_FILE..."
    # Read non-empty, non-comment lines from the file
    FLATPAKS=($(grep -v '^[[:space:]]*#' "$FLATPAKS_FILE" | grep -v '^[[:space:]]*$' | tr '\n' ' '))
    
    if [ ${#FLATPAKS[@]} -gt 0 ]; then
        echo "Installing ${#FLATPAKS[@]} Flatpaks..."
        for flatpak in "${FLATPAKS[@]}"; do
            echo "Installing: $flatpak"
            flatpak install --system --noninteractive flathub "$flatpak" || echo "Failed to install $flatpak"
        done
        echo "✓ Flatpak applications installation complete"
    else
        echo "No Flatpaks specified for installation in $FLATPAKS_FILE"
    fi
else
    echo "Flatpaks file not found: $FLATPAKS_FILE"
    echo "You can create this file to specify Flatpaks to install"
fi

# Apply Flatpak overrides for better integration
echo "Applying Flatpak overrides..."
flatpak override --user io.github.kolunmi.Bazaar --filesystem=host-etc

# Enable GNOME Shell extensions
echo "Enabling GNOME Shell extensions..."

# Enable each extension using dconf
dconf write /org/gnome/shell/enabled-extensions "['app-hider@lynith.dev', 'caffeine@patapon.info', 'AlphabeticalAppGrid@stuarthayhurst', 'dash-to-dock@micxgx.gmail.com', 'appindicatorsupport@rgcjonas.gmail.com', 'hide-cursor@elcste.com', 'panel-corners@aunetx', 'smile-extension@mijorus.it', 'grand-theft-focus@zalckos.github.com', 'blur-my-shell@aunetx', 'add-to-desktop@tommimon.github.com', 'gtk4-ding@smedius.gitlab.com']"

# Configure dash-to-dock extension
gsettings set org.gnome.shell.extensions.dash-to-dock dock-position BOTTOM
gsettings set org.gnome.shell.extensions.dash-to-dock extend-height false
gsettings set org.gnome.shell.extensions.dash-to-dock dock-fixed false
gsettings set org.gnome.shell.extensions.dash-to-dock autohide true
gsettings set org.gnome.shell.extensions.dash-to-dock intellihide true
gsettings set org.gnome.shell.extensions.dash-to-dock click-action 'minimize'

# Enable user-theme extension
gsettings set org.gnome.shell.extensions.user-theme name ""

# Configure GNOME settings
echo "Configuring GNOME settings..."

# Set up favorite apps in dock
gsettings set org.gnome.shell favorite-apps "['org.gnome.Nautilus.desktop', 'org.mozilla.firefox.desktop', 'org.gnome.Evolution.desktop', 'com.ranfdev.DistroShelf.desktop', 'io.github.kolunmi.Bazaar.desktop']"

# Configure interface settings
gsettings set org.gnome.desktop.interface clock-show-weekday true
gsettings set org.gnome.desktop.interface show-battery-percentage true
gsettings set org.gnome.desktop.interface enable-hot-corners false
gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'

# Configure window management
gsettings set org.gnome.desktop.wm.preferences button-layout "appmenu:minimize,maximize,close"
gsettings set org.gnome.desktop.wm.preferences focus-mode 'click'

# Configure file manager
gsettings set org.gnome.nautilus.preferences show-hidden-files false
gsettings set org.gnome.nautilus.preferences show-image-thumbnails 'always'

# Set up wallpaper (if custom wallpaper exists)
if [ -f "/usr/share/backgrounds/homeos-default.jpg" ]; then
    gsettings set org.gnome.desktop.background picture-uri "file:///usr/share/backgrounds/homeos-default.jpg"
    gsettings set org.gnome.desktop.background picture-uri-dark "file:///usr/share/backgrounds/homeos-default.jpg"
fi

# Configure power settings
gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-timeout 3600
gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-timeout 1800

# Set up automatic screen lock
gsettings set org.gnome.desktop.screensaver lock-enabled true
gsettings set org.gnome.desktop.screensaver lock-delay 300

# Configure privacy settings
gsettings set org.gnome.desktop.privacy report-technical-problems false
gsettings set org.gnome.desktop.privacy send-software-usage-stats false

echo "✓ GNOME configuration complete"

# Set up custom GNOME keybindings
echo "Configuring custom GNOME shortcuts..."

# Close windows with Super-Q
gsettings set org.gnome.desktop.wm.keybindings close "['<Super>q']"

# Enable fullscreen with Super-F
gsettings set org.gnome.desktop.wm.keybindings toggle-fullscreen "['<Super>f']"

# Launch MissionCenter with Shift-Super-M
gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/']"
gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ name "Resources"
gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ command "net.nokyan.Resources"
gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ binding "<Shift><Super>m"

# Open home folder with Super-E
gsettings set org.gnome.settings-daemon.plugins.media-keys home "['<Super>e']"

# Start default browser with Super-B
gsettings set org.gnome.settings-daemon.plugins.media-keys www "['<Super>b']"

echo "✓ Custom keybindings configured"

# Setup hidden apps
echo "Setting up hidden applications..."
dconf write /org/gnome/shell/extensions/app-hider/hidden-apps "['htop.desktop', 'nvtop.desktop', 'org.gnome.Ptyxis.desktop']"
echo "✓ Hidden applications configured"

# Set up demonhide autostart
echo "Setting up demonhide autostart..."
cat > "$HOME/.config/autostart/demonhide.desktop" << 'AUTOSTART_EOF'
[Desktop Entry]
Type=Application
Name=DemonHide
Comment=Hide system tray applications
Exec=demonhide
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
StartupNotify=false
AUTOSTART_EOF

echo "✓ DemonHide autostart configured"

# Set up Damask autostart
echo "Setting up Damask autostart..."
cat > "$HOME/.config/autostart/damask.desktop" << 'AUTOSTART_EOF'
[Desktop Entry]
Type=Application
Name=app.drey.Damask
X-XDP-Autostart=app.drey.Damask
Exec=flatpak run --command=damask app.drey.Damask --background
X-Flatpak=app.drey.Damask
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
StartupNotify=false
AUTOSTART_EOF

echo "✓ Damask autostart configured"

# Mark setup as complete with version
mkdir -p "$HOME/.config"
echo "$SCRIPT_VERSION" > "$VERSION_FILE"
echo "✓ homeOS user setup complete (version $SCRIPT_VERSION)"

# Show welcome notification (only on first install, not upgrades)
if [ -z "$CURRENT_VERSION" ] && command -v notify-send &> /dev/null; then
    LANG_CODE=${LANG:0:2}  # "de" für Deutsch, "en" für Englisch usw.
    if [ "$LANG_CODE" = "de" ]; then
        notify-send "Willkommen bei homeOS!" "Ihr Desktop wurde konfiguriert. Viel Spaß mit Ihrem neuen System!" --icon=dialog-information
    else
        notify-send "Welcome to homeOS!" "Your desktop has been configured. Enjoy your new system!" --icon=dialog-information
    fi
fi